/*! <anderpang@foxmail.com> */
(function(t,e){typeof exports==="object"?(exports.__esModule=true,exports.default=e()):t.obj2json=e()})(this,function(){var o=function(t){this.files=t;this.mtls=[];this.objects=[];this.vertices=[];this.normals=[]};o.prototype.parse=function(t,e,r,n){var i=t.split("\n");i.push(null);var s=0;var a=null;var o="";var c;var v=new b;while((c=i[s++])!=null){v.init(c);var l=v.getWord();if(l==null)continue;switch(l){case"#":continue;case"mtllib":var u=v.getWord();var h=new y;this.mtls.push(h);var f=this.files[u];if(f){I(f,h)}else{h.complete=true}continue;case"o":case"g":var p=this.parseObjectName(v);this.objects.push(p);a=p;continue;case"v":var d=this.parseVertex(v,e,n);this.vertices.push(d);continue;case"vn":var m=this.parseNormal(v,n);this.normals.push(m);continue;case"usemtl":o=this.parseUsemtl(v);continue;case"f":var g=this.parseFace(v,o,this.vertices,r);a.addFace(g);continue}}return true};o.prototype.parseObjectName=function(t){var e=t.getWord();return new r(e)};o.prototype.parseVertex=function(t,e,r){var n=t.getFloat()*e;var i=t.getFloat()*e;var s=t.getFloat()*e;if(r!==-1){n=(n*r+.5|0)/r;i=(i*r+.5|0)/r;s=(s*r+.5|0)/r}return new a(n,i,s)};o.prototype.parseNormal=function(t,e){var r=t.getFloat();var n=t.getFloat();var i=t.getFloat();if(e!==-1){r=(r*e+.5|0)/e;n=(n*e+.5|0)/e;i=(i*e+.5|0)/e}return new w(r,n,i)};o.prototype.parseUsemtl=function(t){var e=t.getWord(),r=e.toLowerCase();if(r==="none"||r==="null"){e=""}return e};o.prototype.parseFace=function(t,e,r,n){var i=new x(e);for(;;){var s=t.getWord();if(s==null)break;var a=s.split("/");if(a.length>=1){var o=parseInt(a[0])-1;i.vIndices.push(o)}if(a.length>=3){var c=parseInt(a[2])-1;i.nIndices.push(c)}else{i.nIndices.push(-1)}}var v=[r[i.vIndices[0]].x,r[i.vIndices[0]].y,r[i.vIndices[0]].z];var l=[r[i.vIndices[1]].x,r[i.vIndices[1]].y,r[i.vIndices[1]].z];var u=[r[i.vIndices[2]].x,r[i.vIndices[2]].y,r[i.vIndices[2]].z];var h=F(v,l,u);if(h==null){if(i.vIndices.length>=4){var f=[r[i.vIndices[3]].x,r[i.vIndices[3]].y,r[i.vIndices[3]].z];h=F(l,u,f)}if(h==null){h=[0,1,0]}}if(n){h[0]=-h[0];h[1]=-h[1];h[2]=-h[2]}i.normal=new w(h[0],h[1],h[2]);if(i.vIndices.length>3){var p=i.vIndices.length-2;var d=new Array(p*3);var m=new Array(p*3);for(var g=0;g<p;g++){d[g*3+0]=i.vIndices[0];d[g*3+1]=i.vIndices[g+1];d[g*3+2]=i.vIndices[g+2];m[g*3+0]=i.nIndices[0];m[g*3+1]=i.nIndices[g+1];m[g*3+2]=i.nIndices[g+2]}i.vIndices=d;i.nIndices=m}i.numIndices=i.vIndices.length;return i};function I(t,e){var r=t.trim().split("\n");r.push(null);var n=0;var i;var s="";var a=new b;while((i=r[n++])!==null){i=i.trim();if(i===""){continue}a.init(i);var o=a.getWord();if(o==null)continue;switch(o){case"#":continue;case"newmtl":s=e.parseNewmtl(a);continue;case"Kd":if(s==="")continue;var c=e.parseRGB(a,s);e.materials.push(c);s="";continue}}e.complete=true}o.prototype.isMTLComplete=function(){if(this.mtls.length==0)return true;for(var t=0;t<this.mtls.length;t++){if(!this.mtls[t].complete)return false}return true};o.prototype.findColor=function(t){for(var e=0;e<this.mtls.length;e++){for(var r=0;r<this.mtls[e].materials.length;r++){if(this.mtls[e].materials[r].name===t){return this.mtls[e].materials[r].color}}}return new c(0,0,0,1)};o.prototype.getDrawingInfo=function(){var t=[];var e=[];var r=[];var n=[];var i=0;for(var s=0,a=this.objects.length;s<a;s++){var o=this.objects[s];for(var c=0;c<o.faces.length;c++){var v=o.faces[c];var l=this.findColor(v.materialName);var u=v.normal;for(var h=0;h<v.vIndices.length;h++){n[i]=i;var f=v.vIndices[h];var p=this.vertices[f];t[i*3+0]=p.x;t[i*3+1]=p.y;t[i*3+2]=p.z;r[i*4+0]=l.r;r[i*4+1]=l.g;r[i*4+2]=l.b;r[i*4+3]=l.a;var d=v.nIndices[h];if(d>=0){var m=this.normals[d];e[i*3+0]=m.x;e[i*3+1]=m.y;e[i*3+2]=m.z}else{e[i*3+0]=u.x;e[i*3+1]=u.y;e[i*3+2]=u.z}i++}}}return g(t,e,r,n)};var y=function(){this.complete=false;this.materials=new Array(0)};y.prototype.parseNewmtl=function(t){return t.getWord()};y.prototype.parseRGB=function(t,e){var r=t.getFloat();var n=t.getFloat();var i=t.getFloat();return new s(e,r,n,i,1)};var s=function(t,e,r,n,i){this.name=t;this.color=new c(e,r,n,i)};var a=function(t,e,r){this.x=t;this.y=e;this.z=r};var w=function(t,e,r){this.x=t;this.y=e;this.z=r};var c=function(t,e,r,n){this.r=t;this.g=e;this.b=r;this.a=n};var r=function(t){this.name=t;this.faces=new Array(0);this.numIndices=0};r.prototype.addFace=function(t){this.faces.push(t);this.numIndices+=t.numIndices};var x=function(t){this.materialName=t;if(t==null)this.materialName="";this.vIndices=new Array(0);this.nIndices=new Array(0)};var g=function(t,e,r,n){var i=Object.create(null);i.vertices=t;i.normals=e;i.colors=r;i.indices=n;return i};var b=function(t){this.str;this.index;this.init(t)};b.prototype.init=function(t){this.str=t;this.index=0};b.prototype.skipDelimiters=function(){for(var t=this.index,e=this.str.length;t<e;t++){var r=this.str.charAt(t);if(r=="\t"||r==" "||r=="("||r==")"||r=='"')continue;break}this.index=t};b.prototype.skipToNextWord=function(){this.skipDelimiters();var t=n(this.str,this.index);this.index+=t+1};b.prototype.getWord=function(){this.skipDelimiters();var t=n(this.str,this.index);if(t==0)return null;var e=this.str.substr(this.index,t);this.index+=t+1;return e};b.prototype.getInt=function(){return parseInt(this.getWord())};b.prototype.getFloat=function(){return parseFloat(this.getWord(),10)};function n(t,e){var r=0;for(var n=e,i=t.length;n<i;n++){var s=t.charAt(n);if(s=="\t"||s==" "||s=="("||s==")"||s=='"')break}return n-e}function F(t,e,r){var n=new Float32Array(3);var i=new Float32Array(3);for(var s=0;s<3;s++){n[s]=t[s]-e[s];i[s]=r[s]-e[s]}var a=[];a[0]=n[1]*i[2]-n[2]*i[1];a[1]=n[2]*i[0]-n[0]*i[2];a[2]=n[0]*i[1]-n[1]*i[0];var o=new v(a);o.normalize();return o.elements}var v=function(t){this.elements=new Float32Array(t||3)};v.prototype.normalize=function(){var t=this.elements;var e=t[0],r=t[1],n=t[2],i=Math.sqrt(e*e+r*r+n*n);if(i){if(i==1)return this}else{t[0]=t[1]=t[2]=0;return this}i=1/i;t[0]=e*i;t[1]=r*i;t[2]=n*i;return this};var t=function(t){var e;var r;var n;var i=1;var s=false;var a=-1;if(typeof t==="object"){n=l(t.files);if(!isNaN(t.scale)){i=t.scale}if(typeof t.reverse!=="undefined"){s=t.reverse}if(!isNaN(t.precision)&&t.precision>=0){a=Math.pow(10,t.precision|0)}e=new o(t)}else{n=t;e=new o({})}r=e.parse(n,i,s,a);if(!r){throw"Parse failure"}return e.getDrawingInfo()};function l(t){if(!t){throw"Missing parameter options.files"}var e=Object.keys(t),r=-1,n=e.length;while(n--){if(e[n].toLowerCase().indexOf(".obj")){r=n;break}}if(r===-1){return""}return t[e[r]]}return t});
